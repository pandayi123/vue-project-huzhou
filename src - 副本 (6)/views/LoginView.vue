<!--
è¿™é¡¹è®¾è®¡å¯ä»¥æç‚¼ä¸ºä¸€å¥—åŸºäºRBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰çš„åˆ†çº§æƒé™ä½“ç³»ä¸åŠ¨æ€å¤šå› å­/å¤šäººé‰´æƒæœºåˆ¶ã€‚

ä»¥ä¸‹æ˜¯ä¸ºæ‚¨æ•´ç†çš„ç³»ç»Ÿè®¾è®¡é€»è¾‘æ‘˜è¦ï¼Œå¯ç›´æ¥ç”¨äºæŠ€æœ¯æ–‡æ¡£æˆ–éœ€æ±‚è¯´æ˜ä¹¦ä¸­ï¼š

1. æƒé™ä½“ç³»è®¾è®¡ (RBAC Model)

ç³»ç»Ÿé‡‡ç”¨ä¸‰çº§é‡‘å­—å¡”æƒé™æ¨¡å‹ï¼Œä¸¥æ ¼æ§åˆ¶ç®¡ç†è¾¹ç•Œï¼š

Level 1: æ™®é€šç”¨æˆ· (User)

æƒé™èŒƒå›´ï¼šä»…æ‹¥æœ‰åŸºç¡€ä¸šåŠ¡æ“ä½œæƒé™ï¼ˆå¦‚å­˜å–ã€æŸ¥è¯¢ï¼‰ã€‚

ç®¡ç†èƒ½åŠ›ï¼šæ— è´¦å·ç®¡ç†æƒé™ã€‚

Level 2: ç®¡ç†å‘˜ (Admin)

æƒé™èŒƒå›´ï¼šæ‹¥æœ‰â€œå‘ä¸‹ç®¡ç†â€æƒé™ã€‚

ç®¡ç†èƒ½åŠ›ï¼šå¯å¢åˆ æ”¹æŸ¥ User è´¦å·ï¼›ä¸å¯åˆ›å»ºã€ä¿®æ”¹æˆ–åˆ é™¤ Admin åŠæ›´é«˜ç­‰çº§è´¦å·ï¼ˆé˜²æ­¢æƒé™æ»¥ç”¨æˆ–å¹³è¡Œè¶Šæƒï¼‰ã€‚

Level 3: ç³»ç»Ÿç®¡ç†å‘˜ (System Admin)

æƒé™èŒƒå›´ï¼šæ‹¥æœ‰â€œå…¨åŸŸç®¡ç†â€æƒé™ (Root/Superuser)ã€‚

ç®¡ç†èƒ½åŠ›ï¼šå¯ç®¡ç†æ‰€æœ‰å±‚çº§è´¦å·ï¼ˆå«è‡ªèº«å’Œå…¶ä»– System Adminï¼‰ï¼Œæ‹¥æœ‰ç³»ç»Ÿçš„æœ€é«˜æ§åˆ¶æƒã€‚

2. ç™»å½•é‰´æƒé€»è¾‘ (Authentication Logic)

ç™»å½•é‡‡ç”¨å¯é…ç½®çš„åŠ¨æ€å¤šäºº/å¤šå› å­éªŒè¯ç­–ç•¥ï¼Œç”±æ•°æ®åº“å­—æ®µç›´æ¥é©±åŠ¨å‰ç«¯éªŒè¯æ§½ä½ï¼ˆSlotsï¼‰ï¼š

åŠ¨æ€éªŒè¯è§„åˆ™ (N+M+K æ¨¡å‹)ï¼š

éœ€ N äººæ™®é€šç”¨æˆ·éªŒè¯ (auth_user_required)

éœ€ M äººç®¡ç†å‘˜éªŒè¯ (auth_admin_required)

éœ€ K äººå®¡æ‰¹äºº/è¿œç¨‹éªŒè¯ (auth_approver_required)

æ³¨ï¼šå½“ auth_approver_required = 1 æ—¶ï¼Œè§¦å‘è¿œç¨‹å¹³å°å®¡æ‰¹æµç¨‹ã€‚

éªŒè¯æµç¨‹ï¼š
å‰ç«¯æ ¹æ®ä¸Šè¿°å‚æ•°åŠ¨æ€æ¸²æŸ“éªŒè¯å¡ç‰‡ï¼ˆSlotï¼‰ï¼Œç”¨æˆ·éœ€ä¾æ¬¡å®Œæˆæ‰€æœ‰æ§½ä½çš„èº«ä»½è®¤è¯ï¼ˆäººè„¸/æŒ‡çº¹/å¯†ç /åŠ¨æ€ç ï¼‰æ–¹å¯è§£é”è¿›å…¥ç³»ç»Ÿã€‚

3. ç‰¹æƒè±å…ç­–ç•¥ (Privilege Bypass)

è¶…çº§é€šé“ï¼šSystem Admin è´¦å·å…·å¤‡æœ€é«˜ä¼˜å…ˆçº§çš„é‰´æƒè±å…æƒã€‚

é€»è¾‘è¡¨ç°ï¼šæ— è®ºå½“å‰é…ç½®äº†ä½•ç§å¤æ‚çš„å¤šäººéªŒè¯è§„åˆ™ï¼ˆä¾‹å¦‚éœ€è¦2ç®¡ç†å‘˜+1è¿œç¨‹å®¡æ‰¹ï¼‰ï¼Œä¸€æ—¦è¯†åˆ«åˆ°ç™»å½•è€…èº«ä»½ä¸º System Adminï¼ˆé€šè¿‡äººè„¸æˆ–ä¸“ç”¨åŠ¨æ€ç ï¼‰ï¼Œç³»ç»Ÿå°†ç«‹å³è·³è¿‡å‰©ä½™æ‰€æœ‰éªŒè¯æ­¥éª¤ï¼Œç›´æ¥é€šè¿‡ç™»å½•ã€‚

ä¸€å¥è¯æ€»ç»“ï¼š
ç³»ç»Ÿå®ç°äº†ä¸€ä¸ªä¸‰çº§å‚ç›´æƒé™ç®¡ç†æ¶æ„ï¼Œå‰ç«¯ç™»å½•æ”¯æŒåŸºäºæ•°æ®åº“é…ç½®çš„åŠ¨æ€å¤šäººç»„åˆéªŒè¯ï¼Œå¹¶ä¿ç•™äº†ç³»ç»Ÿç®¡ç†å‘˜çš„æ— æ¡ä»¶ç‰¹æƒé€šè¡Œèƒ½åŠ›ã€‚
-->
<template>
  <div class="auth-wrapper">
    <!-- 1. é¡¶éƒ¨ï¼šæ ‡é¢˜ä¸çŠ¶æ€ -->
    <header class="header">
      <div class="title-box">
        <div class="icon-shield">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z" />
          </svg>
        </div>
        <div>
          <h1>å®‰å…¨è®¿é—®æ§åˆ¶</h1>
          <p>è¯·å®Œæˆä»¥ä¸‹ {{ totalRequired }} é¡¹èº«ä»½éªŒè¯</p>
        </div>
        <!-- ğŸ‘‡ æ–°å¢ï¼šå€’è®¡æ—¶æ˜¾ç¤º -->
        <div class="countdown-timer" v-if="countdown > 0">
          <!-- ğŸ‘‡ ä¿®æ”¹è¿™é‡Œ -->
          <el-icon class="icon-hourglass" :size="16">
            <Clock />
          </el-icon>
          {{ countdown }}s åè‡ªåŠ¨è¿”å›
        </div>

      </div>

      <button class="btn-close" @click="$router.back()">å–æ¶ˆ</button>
    </header>

    <!-- 2. ä¸­éƒ¨ï¼šåŠ¨æ€éªŒè¯æ§½ä½ -->
    <div class="slots-container">
      <div v-for="(slot, index) in verificationSlots" :key="slot.id" class="auth-slot" :class="{
        'is-active': currentSlotIndex === index,
        'is-verified': slot.verified,
      }" @click="activateSlot(index)">
        <div class="slot-status">
          <span v-if="slot.verified" class="icon-check">âœ“</span>
          <span v-else class="text-pending">{{ index + 1 }}</span>
        </div>
        <div class="slot-info">
          <span class="role-name">{{ slot.roleName }}</span>
          <span class="role-desc">{{ slot.verified ? 'éªŒè¯é€šè¿‡' : 'å¾…éªŒè¯' }}</span>
        </div>
        <div class="active-bar"></div>
      </div>
    </div>

    <!-- 3. åº•éƒ¨ï¼šéªŒè¯äº¤äº’åŒº -->
    <transition name="slide-up">
      <div class="interaction-area" v-if="currentSlot && !currentSlot.verified">
        <!-- éªŒè¯æ–¹å¼åˆ‡æ¢ -->
        <div class="method-tabs">
          <div v-for="method in authMethods" :key="method.key" class="tab-item"
            :class="{ active: currentMethod === method.key }" @click="switchMethod(method.key)">
            <span class="tab-icon">{{ method.icon }}</span>
            <span>{{ method.label }}</span>
          </div>
        </div>

        <!-- éªŒè¯é¢æ¿ -->
        <div class="auth-panel">
          <!-- A. äººè„¸è¯†åˆ«æ¨¡å¼ (å·²ä¿®æ”¹ä¸º Video) -->
          <div v-if="currentMethod === 'face'" class="panel-face">
            <div class="video-container">
              <video ref="videoRef" autoplay muted class="camera-view"></video>
              <!-- å¯é€‰ï¼šæ·»åŠ æ‰«æåŠ¨ç”»è¦†ç›–å±‚ -->
              <div class="scan-line"></div>
              <div class="face-text-overlay">æ­£åœ¨æ‰«æ {{ currentSlot.roleName }}...</div>
            </div>
          </div>

          <!-- B. æŒ‡çº¹è¯†åˆ«æ¨¡å¼ (çœŸå®) -->
          <div v-if="currentMethod === 'finger'" class="panel-finger">
            <!-- ä¼ å…¥ç»„ä»¶ï¼Œç›‘å¬ success äº‹ä»¶ -->
            <AuthFingerprint @success="handleFingerprintSuccess" />
          </div>

          <!-- C & D. æ•°å­—é”®ç›˜æ¨¡å¼ -->
          <div v-if="['password', 'otp'].includes(currentMethod)" class="panel-numpad">
            <div class="input-screen" :class="{ 'shake-anim': hasError }">
              <span class="input-label" :class="{ 'text-error': hasError }">
                {{
                  hasError
                    ? errorMessage
                    : currentMethod === 'otp'
                      ? 'è¯·è¾“å…¥ 8 ä½åŠ¨æ€éªŒè¯ç '
                      : 'è¯·è¾“å…¥ 8 ä½æ•°å­—å¯†ç '
                }}
              </span>
              <div class="dots">
                <span v-for="n in 8" :key="n" class="dot" :class="{
                  filled: getInputLength() >= n,
                  error: hasError,
                }"></span>
              </div>
            </div>

            <div class="numpad-grid" :class="{ disabled: isVerifying }">
              <button v-for="n in 9" :key="n" @click="handleNumpadInput(n)">{{ n }}</button>
              <button class="action-btn" @click="clearInput()">æ¸…ç©º</button>
              <button @click="handleNumpadInput(0)">0</button>
              <button class="action-btn delete" @click="handleNumpadInput('del')">âŒ«</button>
            </div>
          </div>
        </div>
      </div>
    </transition>

    <!-- éªŒè¯æˆåŠŸ -->
    <div v-if="allVerified" class="success-overlay">
      <div class="success-content">
        <div class="checkmark-circle">âœ“</div>
        <h2>éªŒè¯é€šè¿‡</h2>
        <p>æ­£åœ¨è¿›å…¥ {{ targetActionName }}...</p>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, onUnmounted, toRaw } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import { useTimerStore } from '@/stores/timerStore'
import { useAudioStore } from '@/stores/audioStore'
import AuthFingerprint from '@/components/AuthFingerprint.vue'
import AuthFace from '@/components/AuthFace.vue'
import { Clock, /* ...å…¶ä»–å›¾æ ‡ */ } from '@element-plus/icons-vue'
const audioStore = useAudioStore()
const router = useRouter()
const route = useRoute()
const timerStore = useTimerStore()

// ==========================================
// ğŸ‘‡ 1. æ–°å¢ï¼šå€’è®¡æ—¶çŠ¶æ€
// ==========================================
const countdown = ref(60) // åˆå§‹å€’è®¡æ—¶ç§’æ•°
const countdownTimer = ref(null) // ç”¨äºå­˜å‚¨ setInterval çš„ ID
// ==========================================

// ==========================================
// ğŸ‘‡ 2. æ–°å¢ï¼šå¯åŠ¨å€’è®¡æ—¶çš„å‡½æ•°
// ==========================================
const startCountdown = () => {
  // å…ˆæ¸…é™¤æ—§çš„ï¼Œé˜²æ­¢é‡å¤å¯åŠ¨
  if (countdownTimer.value) clearInterval(countdownTimer.value)

  countdown.value = 60 // æ¯æ¬¡é‡ç½®ä¸º 60 ç§’

  countdownTimer.value = setInterval(() => {
    countdown.value--

    if (countdown.value <= 0) {
      // å€’è®¡æ—¶ç»“æŸï¼Œæ‰§è¡Œè¿”å›æ“ä½œ
      clearInterval(countdownTimer.value)
      router.back() // æˆ– router.push('/')
    }
  }, 1000)
}
// ==========================================

// ==========================================
// ğŸ‘‡ 3. æ–°å¢ï¼šé‡ç½®/åœæ­¢å€’è®¡æ—¶çš„å‡½æ•°
// ==========================================
const stopCountdown = () => {
  if (countdownTimer.value) {
    clearInterval(countdownTimer.value)
    countdownTimer.value = null
  }
}
// ==========================================

const targetActionName = computed(() => route.query.actionName || 'ç³»ç»Ÿ')

const auth_page = ref({
  auth_user_required: 0,
  auth_admin_required: 2,
  auth_approver_required: 1,
})

// æ–°å¢ï¼šå­˜å‚¨ä»æ•°æ®åº“è·å–çš„å®Œæ•´é…ç½®
const terminalSettings = ref(null)

const verificationSlots = ref([])
const currentSlotIndex = ref(0)
const currentMethod = ref('face')

// è¾“å…¥çŠ¶æ€
const otpInput = ref('')
const passwordInput = ref('')
const isVerifying = ref(false)
const hasError = ref(false)
const errorMessage = ref('')
const videoRef = ref(null) // è§†é¢‘å…ƒç´ å¼•ç”¨

const authMethods = [
  { key: 'face', label: 'äººè„¸', icon: 'â˜º' },
  { key: 'finger', label: 'æŒ‡çº¹', icon: 'â˜' },
  { key: 'password', label: 'å¯†ç ', icon: 'âŒ¨' },
  { key: 'otp', label: 'åŠ¨æ€ç ', icon: 'â±' },
]

const currentSlot = computed(() => verificationSlots.value[currentSlotIndex.value])
const totalRequired = computed(() => verificationSlots.value.length)
const allVerified = computed(
  () =>
    verificationSlots.value.length > 0 && verificationSlots.value.every((slot) => slot.verified),
)

// 1. æ–°å¢ï¼šå·²éªŒè¯ç”¨æˆ·IDé›†åˆ (é˜²æ­¢ä¸€äººå¤šé¥°)
// ======================================================
const verifiedUserIds = ref(new Set())

// ======================================================
// 2. æ–°å¢ï¼šç»Ÿä¸€èº«ä»½æ ¸éªŒåç½®å¤„ç†å™¨ (Gatekeeper)
//    æ‰€æœ‰éªŒè¯æ–¹å¼(å¯†ç /OTP/äººè„¸/æŒ‡çº¹)æœ€ç»ˆéƒ½æ±‡èšåˆ°è¿™é‡Œè¿›è¡Œâ€œæŸ¥é‡â€
// ======================================================
const handleAuthSuccess = async (user) => {
  /*
  verificationSlots å…ƒç´ å±æ€§ç»“æ„
  interface VerificationSlot {
  id: number;               // æ§½ä½å”¯ä¸€æ ‡è¯†
  roleName: string;         // è§’è‰²åç§°ï¼ˆå¦‚â€œæ“ä½œå‘˜â€ã€â€œç®¡ç†å‘˜â€ï¼‰
  type: string;             // è§’è‰²ç±»å‹ï¼ˆå¦‚ 'user', 'admin', 'approver'ï¼‰
  verified: boolean;        // æ˜¯å¦å·²éªŒè¯é€šè¿‡
  verifierInfo?: object;    // å¯é€‰ï¼šéªŒè¯é€šè¿‡åçš„ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚ `{ id: number, real_name: string, role: string }`ï¼‰
  }
  */
  // --- åœºæ™¯ A: ç³»ç»Ÿç®¡ç†å‘˜/è¶…çº§åŠ¨æ€ç  (ç›´æ¥é€šå…³) ---
  if (user.role === 'system_admin' || user.is_system_otp) {
    audioStore.play('/audio/ç³»ç»Ÿç®¡ç†å‘˜ç™»å½•.mp3')
    verificationSlots.value.forEach((slot) => {
      slot.verified = true
      slot.roleName = 'ç³»ç»Ÿç®¡ç†å‘˜'
    })
    triggerLoginSuccess()
    return
  }

  // --- åœºæ™¯ B: æ™®é€šéªŒè¯ (æŸ¥é‡é€»è¾‘) ---

  // 1. [å…³é”®] æ£€æŸ¥æ˜¯å¦é‡å¤éªŒè¯ (ä¸€äººå¤šé¥°æ¼æ´ä¿®å¤)
  if (verifiedUserIds.value.has(user.id)) {
    errorMessage.value = `ç”¨æˆ· [${user.real_name}] å·²éªŒè¯ï¼Œè¯·å‹¿é‡å¤éªŒè¯`
    hasError.value = true
    audioStore.play('/audio/åŒä¸€è´¦å·ç¦æ­¢é‡å¤éªŒè¯.mp3')
    return
  }

  // 2. æ£€æŸ¥æƒé™ (Role Mismatch)
  // ç®€å•é€»è¾‘ï¼šå¦‚æœå½“å‰æ ¼å­éœ€è¦ adminï¼Œä½†æ¥çš„æ˜¯ userï¼Œåˆ™æ‹’ç»
  // (æ³¨ï¼šadmin é€šå¸¸å¯ä»¥è§£é” user æ ¼å­ï¼Œè§†å…·ä½“ä¸šåŠ¡è€Œå®šï¼Œè¿™é‡Œå†™ä¸¥æ ¼åŒ¹é…)
  const requiredRole = currentSlot.value.type
  if (user.role !== requiredRole && user.role !== 'admin') {
    errorMessage.value = `æƒé™ä¸è¶³ï¼šå½“å‰éœ€è¦éªŒè¯ [${currentSlot.value.roleName}]è´¦å·`
    hasError.value = true
    audioStore.play('/audio/æƒé™ä¸è¶³å½“å‰éœ€è¦éªŒè¯ç®¡ç†å‘˜è´¦å·.mp3')
    return
  }

  // --- éªŒè¯é€šè¿‡ ---
  // 1. è®°å½• ID é˜²æ­¢å†æ¬¡ä½¿ç”¨
  verifiedUserIds.value.add(user.id)

  // 2. æ›´æ–° UI çŠ¶æ€
  if (currentSlot.value) {
    currentSlot.value.verified = true
    currentSlot.value.verifierInfo = user
  }

  // 3. æµç¨‹æµè½¬
  if (allVerified.value) {
    triggerLoginSuccess()
  } else {
    audioStore.play('/audio/éªŒè¯é€šè¿‡.mp3')
    setTimeout(() => {
      activateNextUnverifiedSlot()
      resetInputs()
    }, 500)
  }
}
// å¤„ç†æŒ‡çº¹éªŒè¯æˆåŠŸ
const handleFingerprintSuccess = (userData) => {
  console.log('æŒ‡çº¹éªŒè¯é€šè¿‡ï¼Œç”¨æˆ·:', userData)

  // ç¡®ä¿ role å­—æ®µå­˜åœ¨ (å¦‚æœæ•°æ®åº“å­—æ®µåä¸ä¸€æ ·ï¼Œè¿™é‡Œåšä¸€ä¸‹æ˜ å°„)
  // å‡è®¾æ•°æ®åº“é‡Œæƒé™å­—æ®µå« password_permissions æˆ–è€… role
  const user = {
    ...userData,
    role: userData.role || userData.password_permissions || 'user', // é»˜è®¤ fallback
    real_name: userData.user_name || userData.real_name // å…¼å®¹ä¸åŒå­—æ®µå
  }

  console.log('å¤„ç†æŒ‡çº¹éªŒè¯æˆåŠŸï¼Œç”¨æˆ·:', user)

  // è°ƒç”¨ä½ åŸæœ‰çš„æ ¸å¿ƒéªŒè¯é€»è¾‘
  handleAuthSuccess(user)
}
const handleFaceSuccess = (userData) => {
  console.log('äººè„¸éªŒè¯é€šè¿‡ï¼Œç”¨æˆ·:', userData)

  // æ„é€ ç”¨æˆ·å¯¹è±¡ï¼Œç¡®ä¿å­—æ®µåç»Ÿä¸€
  const user = {
    ...userData,
    role: userData.role || userData.password_permissions || 'user',
    real_name: userData.user_name || userData.real_name
  }

  // âœ… å…³é”®ï¼šç›´æ¥è°ƒç”¨ä½ çš„ä¸­å¤®éªŒè¯å¤„ç†å™¨
  handleAuthSuccess(user)
}
// ======================================================
// 5. ç™»å½•æˆåŠŸè·³è½¬
// ======================================================
const triggerLoginSuccess = () => {
  stopCountdown() // âœ… éªŒè¯æˆåŠŸï¼Œå°±ä¸éœ€è¦å†å€’è®¡æ—¶äº†
  setTimeout(() => {
    const targetPath = route.query.redirect || '/'
    router.replace(targetPath)
  }, 1000)
}

// [æ–°å¢] å·¥å…·å‡½æ•°ï¼šæ›´æ–°æ•°æ®åº“å­—æ®µ (ç”¨äºå›å†™å¤±è´¥æ¬¡æ•°ã€é”å®šçŠ¶æ€)
const updateTerminalSettingsDB = async (updates) => {
  try {
    const payload = {
      tableName: 'terminal_settings',
      setValues: updates,
      condition: 'id=1',
    }
    // è°ƒç”¨ electronAPI æ›´æ–°
    await window.electronAPI.el_post({ action: 'update', payload: payload })

    // åŒæ­¥æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼Œç¡®ä¿ç•Œé¢å³æ—¶ååº”
    if (terminalSettings.value) {
      Object.assign(terminalSettings.value, updates)
    }
  } catch (error) {
    console.error('æ›´æ–°æ•°æ®åº“å¤±è´¥:', error)
  }
}

// [æ–°å¢] å·¥å…·å‡½æ•°ï¼šè®¡ç®—å“ˆå¸Œ (ç”¨äºéªŒè¯)
// é€»è¾‘ä¸¥æ ¼å¯¹é½ plugins.js ä¸­çš„åŠ å¯†æ–¹å¼
const computeHashForVerification = async (plainCode, saltHex) => {
  const ITERATIONS = 10000
  const KEY_LEN = 64
  const ALGO = 'SHA-512'

  const enc = new TextEncoder()

  // 1. å¯¼å…¥å¯†é’¥ææ–™
  const keyMaterial = await window.crypto.subtle.importKey(
    'raw',
    enc.encode(plainCode),
    { name: 'PBKDF2' },
    false,
    ['deriveBits'],
  )

  // 2. ä½¿ç”¨æ•°æ®åº“ä¸­çš„ Salt è¿›è¡Œæ´¾ç”Ÿ (æ³¨æ„ï¼šplugins.js ä½¿ç”¨ enc.encode(saltHex))
  const derivedBits = await window.crypto.subtle.deriveBits(
    {
      name: 'PBKDF2',
      salt: enc.encode(saltHex),
      iterations: ITERATIONS,
      hash: ALGO,
    },
    keyMaterial,
    KEY_LEN * 8,
  )

  // 3. è½¬ Hex å­—ç¬¦ä¸²
  const hashHex = Array.from(new Uint8Array(derivedBits))
    .map((b) => b.toString(16).padStart(2, '0'))
    .join('')

  return hashHex
}

const fetchData = async () => {
  console.log('fetchData')
  // å…ˆæ‰§è¡Œä¸€æ¬¡å¼€å…³åˆ—è¡¨åˆ·æ–°ç¡¬ä»¶çŠ¶æ€
  const response = await window.electronAPI.el_post({
    action: 'queryMultipleTables',
    payload: {
      arr: [{ tablename: 'terminal_settings', condition: 'id=1' }],
    },
  })
  console.log('el_postè°ƒç”¨è¿”å›çš„æ•°æ®:', toRaw(response))
  if (response?.success && response.data) {
    const settings = response.data.terminal_settings
    console.log('ç»ˆç«¯è®¾ç½®æ•°æ®terminal_settingsåŠ è½½æˆåŠŸ:', toRaw(settings))

    // 1. ä¿å­˜åˆ° ref ä¸­ä¾›éªŒè¯é€»è¾‘ä½¿ç”¨
    terminalSettings.value = settings

    // 2. æ ¹æ®æ•°æ®åº“é…ç½®æ›´æ–°é¡µé¢æƒé™è¦æ±‚
    auth_page.value = {
      auth_user_required: settings.auth_user_required || 0,
      auth_admin_required: settings.auth_admin_required || 0,
      auth_approver_required: settings.auth_approver_required || 0,
    }

    // 3. æ•°æ®åŠ è½½å®Œæ¯•åï¼Œé‡æ–°ç”ŸæˆéªŒè¯æ’æ§½
    generateSlots()
  }
}
onMounted(() => {
  fetchData() // [ä¿®æ”¹] å»ºè®®å…ˆè°ƒç”¨æ•°æ®è·å–
  // generateSlots() // å¯ä»¥æ³¨é‡Šæ‰è¿™é‡Œçš„è°ƒç”¨ï¼Œæ”¹ä¸ºåœ¨ fetchData æˆåŠŸåè°ƒç”¨
  if (timerStore.isTimerActive) timerStore.stopInterval()
  startCamera()

  // âœ… åœ¨ç»„ä»¶æŒ‚è½½æ—¶å¯åŠ¨å€’è®¡æ—¶
  startCountdown()
})

onUnmounted(() => {
  // if (!timerStore.isTimerActive) timerStore.startInterval()
  // åœæ­¢æ‘„åƒå¤´æµ
  stopCamera()
  // âœ… åœ¨ç»„ä»¶é”€æ¯æ—¶ï¼ŒåŠ¡å¿…æ¸…ç†å®šæ—¶å™¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
  stopCountdown()
})
const stopCamera = () => {
  if (videoRef.value) {
    videoRef.value.style.display = 'block'
  }
  if (mediaStream) {
    mediaStream.getTracks().forEach((track) => track.stop())
    mediaStream = null
  }
}
const generateSlots = () => {
  const slots = []
  let idCounter = 1
  for (let i = 0; i < auth_page.value.auth_user_required; i++)
    slots.push({ id: idCounter++, roleName: 'æ“ä½œå‘˜', type: 'user', verified: false })
  for (let i = 0; i < auth_page.value.auth_admin_required; i++)
    slots.push({ id: idCounter++, roleName: 'ç®¡ç†å‘˜', type: 'admin', verified: false })
  for (let i = 0; i < auth_page.value.auth_approver_required; i++)
    slots.push({ id: idCounter++, roleName: 'å®¡æ‰¹äºº', type: 'approver', verified: false })
  verificationSlots.value = slots
  activateNextUnverifiedSlot()
}

const activateSlot = (index) => {
  if (!allVerified.value) {
    currentSlotIndex.value = index
    resetInputs()
  }
}

const switchMethod = (method) => {
  audioStore.play(`/audio/æŒ‰é’®ç‚¹å‡»å£°.mp3`)
  currentMethod.value = method
  resetInputs()
  // åˆ‡æ¢å›äººè„¸æ—¶å¯èƒ½éœ€è¦é‡æ–°å¯åŠ¨æ‘„åƒå¤´
  if (method === 'face') {
    startCamera()
  }
}

const resetInputs = () => {
  otpInput.value = ''
  passwordInput.value = ''
  hasError.value = false
  errorMessage.value = ''
}

const activateNextUnverifiedSlot = () => {
  const nextIndex = verificationSlots.value.findIndex((s) => !s.verified)
  if (nextIndex !== -1) currentSlotIndex.value = nextIndex
}

const getInputLength = () => {
  return currentMethod.value === 'otp' ? otpInput.value.length : passwordInput.value.length
}

const clearInput = () => {
  audioStore.play(`/audio/æ¸…ç©º.mp3`)
  if (isVerifying.value) return
  if (currentMethod.value === 'otp') otpInput.value = ''
  else passwordInput.value = ''
  hasError.value = false
}

const handleNumpadInput = (val) => {
  audioStore.play(`/audio/æ•²é”®ç›˜é€šç”¨å£°éŸ³.mp3`)
  if (isVerifying.value) return

  if (hasError.value) {
    hasError.value = false
    errorMessage.value = ''
    if (currentMethod.value === 'otp') otpInput.value = ''
    else passwordInput.value = ''
  }

  const targetRef = currentMethod.value === 'otp' ? otpInput : passwordInput

  if (val === 'del') {
    targetRef.value = targetRef.value.slice(0, -1)
  } else {
    if (targetRef.value.length < 8) targetRef.value += val
  }

  if (targetRef.value.length === 8) {
    verifyCodeWithBackend(targetRef.value)
  }
}
// æ‘„åƒå¤´ç®¡ç†
let mediaStream = null // åª’ä½“æµå¯¹è±¡
const startCamera = async () => {
  try {
    mediaStream = await navigator.mediaDevices.getUserMedia({
      video: {
        width: { ideal: 640 },
        height: { ideal: 480 },
        facingMode: 'user',
      },
      audio: false,
    })

    if (videoRef.value) {
      videoRef.value.srcObject = mediaStream
    }
  } catch (error) {
    console.error('æ‘„åƒå¤´å¯åŠ¨å¤±è´¥:', error)
  }
}
// [æ–°å¢] ä¿®æ”¹ä¸€ï¼šæ›´æ–°ç”¨æˆ·è¡¨æ•°æ®çš„å·¥å…·å‡½æ•°
const updateUserDB = async (userId, updates) => {
  try {
    await window.electronAPI.el_post({
      action: 'update',
      payload: {
        tableName: 'users',
        setValues: updates,
        condition: `id=${userId}`,
      },
    })
  } catch (error) {
    console.error(`æ›´æ–°ç”¨æˆ·[${userId}]å¤±è´¥:`, error)
  }
}
// [æ–°å¢] ä¿®æ”¹äºŒï¼šæå–é€šç”¨çš„ç»ˆç«¯é”å®š/å¤±è´¥å¤„ç†é€»è¾‘
const handleGlobalFailure = async (settings, now) => {
  const maxAttempts = settings.dynamic_code_max_attempts || 5
  // è¯»å–å½“å‰å¤±è´¥æ¬¡æ•° (é»˜è®¤ä¸º0)
  const currentFail = (settings.dynamic_code_current_failed_count || 0) + 1
  const remaining = maxAttempts - currentFail

  const updates = {
    dynamic_code_current_failed_count: currentFail,
  }

  let errorText = ''
  let audioPath = '/audio/éªŒè¯å¤±è´¥.mp3'

  if (currentFail >= maxAttempts) {
    // è¶…è¿‡æœ€å¤§æ¬¡æ•°ï¼Œé”å®š 30 åˆ†é’Ÿ
    const lockDuration = 30 * 60 * 1000
    const lockDate = new Date(now.getTime() + lockDuration)
    // å†™å…¥é”å®šæ—¶é—´
    updates.dynamic_code_locked_until = toLocalDateTime(lockDate)
    errorText = 'é”™è¯¯è¿‡å¤šï¼Œç³»ç»Ÿå·²é”å®š30åˆ†é’Ÿ'
    audioPath = '/audio/ç³»ç»Ÿå·²é”å®š.mp3'
  } else {
    errorText = `éªŒè¯å¤±è´¥ï¼Œå‰©ä½™ ${remaining} æ¬¡æœºä¼š`
  }

  // æ›´æ–°æ•°æ®åº“
  await updateTerminalSettingsDB(updates)

  // æ˜¾ç¤ºé”™è¯¯
  errorMessage.value = errorText
  hasError.value = true
  isVerifying.value = false
  audioStore.play(audioPath)
}
// [ä¿®æ”¹ä¸‰] é‡æ„åçš„éªŒè¯ä¸»å‡½æ•°
const verifyCodeWithBackend = async (code) => {
  isVerifying.value = true
  const settings = terminalSettings.value

  // 1. åŸºç¡€æ£€æŸ¥
  if (!settings) {
    errorMessage.value = 'ç³»ç»Ÿé…ç½®æœªåŠ è½½'
    hasError.value = true
    isVerifying.value = false
    return
  }

  const now = new Date()

  // 2. å…¨å±€é”å®šæ£€æŸ¥ (é’ˆå¯¹ OTP å’Œ å¯†ç  å‡ç”Ÿæ•ˆ)
  if (settings.dynamic_code_locked_until) {
    const lockTime = new Date(settings.dynamic_code_locked_until.replace(/-/g, '/'))
    if (now < lockTime) {
      errorMessage.value = 'ç³»ç»Ÿå·²é”å®šï¼Œè¯·30åˆ†é’Ÿåå†è¯•'
      audioStore.play(`/audio/ç³»ç»Ÿå·²é”å®š.mp3`)
      hasError.value = true
      isVerifying.value = false
      return
    }
  }

  // =========================================================
  // åˆ†æ”¯ A: åŠ¨æ€ç  (OTP)
  // =========================================================
  if (currentMethod.value === 'otp') {
    // æ£€æŸ¥è¿‡æœŸ
    if (settings.dynamic_code_expiry) {
      const expiry = new Date(settings.dynamic_code_expiry.replace(/-/g, '/'))
      if (now > expiry) {
        errorMessage.value = 'åŠ¨æ€ç å·²è¿‡æœŸ'
        hasError.value = true
        isVerifying.value = false
        audioStore.play(`/audio/åŠ¨æ€ç å·²è¿‡æœŸ.mp3`)
        return
      }
    } else {
      errorMessage.value = 'å°šæœªè®¾ç½®åŠ¨æ€ç '
      hasError.value = true
      isVerifying.value = false
      audioStore.play(`/audio/å°šæœªè®¾ç½®åŠ¨æ€ç .mp3`)
      return
    }

    try {
      // éªŒè¯å“ˆå¸Œ
      const inputHash = await computeHashForVerification(code, settings.dynamic_code_salt)

      if (inputHash === settings.dynamic_code_hash) {
        // --- OTP æˆåŠŸ ---
        // 1. æ¸…é™¤ç»ˆç«¯å…¨å±€é”™è¯¯è®¡æ•°
        await updateTerminalSettingsDB({
          dynamic_code_current_failed_count: 0,
          dynamic_code_locked_until: null,
        })

        // 2. æ„é€ ç”¨æˆ·èº«ä»½
        let identifiedUser = null
        if (settings.dynamic_code_permissions === 'system_admin') {
          identifiedUser = {
            id: 'SYS_OTP_USER',
            real_name: 'åŠ¨æ€ç è´¦å·',
            role: 'system_admin',
            is_system_otp: true,
          }
        } else {
          identifiedUser = {
            id: 'SYS_OTP_USER',
            real_name: 'åŠ¨æ€ç è´¦å·',
            role: settings.dynamic_code_permissions,
            is_system_otp: false,
          }
        }

        isVerifying.value = false
        handleAuthSuccess(identifiedUser)

      } else {
        // --- OTP å¤±è´¥ ---
        // è°ƒç”¨é€šç”¨å¤±è´¥å¤„ç† (ç´¯åŠ è®¡æ•°ã€é”å®š)
        await handleGlobalFailure(settings, now)
      }
    } catch (e) {
      console.error(e)
      isVerifying.value = false
    }
  }

  // =========================================================
  // åˆ†æ”¯ B: å¯†ç  (Password)
  // =========================================================
  else if (currentMethod.value === 'password') {
    try {
      // 1. æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ· (ä½¿ç”¨ queryAll)
      const res = await window.electronAPI.el_post({
        action: 'queryAll',
        payload: {
          tableName: 'users',
          condition: 'status=1',
        },
      })

      let matchedUser = null
      let isUserPersonalLocked = false

      // 2. éå†æ¯”å¯¹
      if (res && (Array.isArray(res) || Array.isArray(res.data))) {
        const userList = Array.isArray(res) ? res : res.data

        for (const user of userList) {
          if (!user.password_hash || !user.salt) continue

          const hash = await computeHashForVerification(code, user.salt)

          if (hash === user.password_hash) {
            // å¯†ç å¯¹ä¸Šäº†ï¼Œæ£€æŸ¥ä¸ªäººé”å®šæ—¶é—´
            if (user.password_locked_until) {
              const lockTime = new Date(user.password_locked_until.replace(/-/g, '/'))
              if (now < lockTime) {
                isUserPersonalLocked = true
                break
              }
            }
            // é€šè¿‡
            matchedUser = user
            matchedUser.role = user.password_permissions || user.role || 'user'
            break
          }
        }
      }

      // 3. ç»“æœåˆ¤æ–­
      if (isUserPersonalLocked) {
        // å¯†ç å¯¹ä½†äººè¢«é”
        errorMessage.value = 'è¯¥è´¦å·å·²è¢«ç®¡ç†å‘˜é”å®š'
        hasError.value = true
        isVerifying.value = false
        audioStore.play('/audio/ç³»ç»Ÿå·²é”å®š.mp3')
      }
      else if (matchedUser) {
        // --- å¯†ç æˆåŠŸ ---

        // 1. æ¸…é™¤ç»ˆç«¯å…¨å±€é”™è¯¯è®¡æ•° (æ—¢ç„¶è¾“å…¥äº†æ­£ç¡®å¯†ç ï¼Œè¯´æ˜æ˜¯è‡ªå·±äºº)
        await updateTerminalSettingsDB({
          dynamic_code_current_failed_count: 0,
          dynamic_code_locked_until: null,
        })

        // 2. æ¸…é™¤ç”¨æˆ·ä¸ªäººé”™è¯¯è®¡æ•°
        await updateUserDB(matchedUser.id, {
          password_current_failed_count: 0,
          password_locked_until: null,
        })

        isVerifying.value = false
        handleAuthSuccess(matchedUser)

      } else {
        // --- å¯†ç å¤±è´¥ ---
        // å…³é”®ç‚¹ï¼šå¯†ç é”™è¯¯ä¹Ÿè°ƒç”¨ handleGlobalFailure
        // è¿™æ ·å¯ä»¥å…±ç”¨ OTP çš„è®¡æ•°å™¨ï¼Œè¾“é”™å¯†ç ä¹Ÿä¼šå¯¼è‡´ç»ˆç«¯é”å®š
        console.log('å¯†ç é”™è¯¯ï¼Œè®¡å…¥ç»ˆç«¯é”™è¯¯æ¬¡æ•°')
        await handleGlobalFailure(settings, now)
      }

    } catch (e) {
      console.error('å¯†ç éªŒè¯å‡ºé”™:', e)
      errorMessage.value = 'ç³»ç»Ÿå†…éƒ¨é”™è¯¯'
      hasError.value = true
      isVerifying.value = false
    }
  }
}

// [æ–°å¢] æœ¬åœ°æ—¶é—´æ ¼å¼åŒ–å‡½æ•° (ä¿®å¤ plugins.toLocalDateTime æŠ¥é”™é—®é¢˜)
const toLocalDateTime = (date) => {
  const d = date || new Date()
  return (
    d.getFullYear() +
    '-' +
    String(d.getMonth() + 1).padStart(2, '0') +
    '-' +
    String(d.getDate()).padStart(2, '0') +
    ' ' +
    String(d.getHours()).padStart(2, '0') +
    ':' +
    String(d.getMinutes()).padStart(2, '0') +
    ':' +
    String(d.getSeconds()).padStart(2, '0')
  )
}
</script>

<style scoped>
/* ä¿æŒåŸæœ‰åŸºç¡€æ ·å¼ä¸å˜ */
.auth-wrapper {
  --primary: #00f2ff;
  --primary-dark: #0099a1;
  --success: #00ff9d;
  --error: #ff4d4f;
  --bg-dark: #0a0e17;
  --card-bg: #141b2d;
  --border: #2a3546;
  --active-bg: #1c2538;

  font-size: 0.25rem;
  width: 100%;
  height: 100vh;
  background-color: var(--bg-dark);
  color: #fff;
  font-family: 'Segoe UI', Roboto, sans-serif;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position: relative;
  user-select: none;
  transform: translateZ(0);
}

.header {
  z-index: 10;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.21rem 0.42rem;
  background: #11151f;
  border-bottom: 1px solid var(--border);
}

.title-box {
  display: flex;
  align-items: center;
  gap: 0.21rem;
}

.icon-shield {
  width: 0.57rem;
  height: 0.57rem;
  color: var(--primary);
}

.title-box h1 {
  margin: 0;
  font-size: 0.3rem;
  font-weight: 600;
  letter-spacing: 0.5px;
}

.title-box p {
  margin: 0;
  font-size: 0.23rem;
  color: #888;
  margin-top: 0.04rem;
}

.btn-close {
  background: transparent;
  border: 1px solid var(--border);
  color: #ccc;
  padding: 0.11rem 0.28rem;
  font-size: 0.25rem;
  border-radius: 0.07rem;
  cursor: pointer;
  transition:
    background-color 0.2s,
    color 0.2s;
}

.btn-close:active {
  background: #333;
  color: #fff;
}

.slots-container {
  z-index: 10;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 0.28rem;
  padding: 0.42rem 0;
  flex-shrink: 0;
}

.auth-slot {
  width: 2.3rem;
  height: 1.5rem;
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: 0.14rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  position: relative;
  cursor: pointer;
  transition:
    border-color 0.2s,
    background-color 0.2s;
  overflow: hidden;
}

.auth-slot.is-active {
  background-color: var(--active-bg);
  border-color: var(--primary);
}

.auth-slot.is-verified {
  background-color: #0f221a;
  border-color: #005533;
}

.slot-status {
  width: 0.35rem;
  height: 0.35rem;
  background: #0e3f96;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 0.11rem;
  font-size: 0.21rem;
  color: #fff;
}

.auth-slot.is-verified .icon-check {
  color: var(--success);
  font-size: 0.21rem;
}

.auth-slot.is-verified .role-name {
  color: var(--success);
}

.role-name {
  font-weight: 600;
  font-size: 0.25rem;
}

.role-desc {
  font-size: 0.25rem;
  color: #666;
  margin-top: 0.04rem;
}

.active-bar {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 2px;
  background: var(--primary);
  transform: scaleX(0);
  transition: transform 0.2s;
}

.auth-slot.is-active .active-bar {
  transform: scaleX(1);
}

.interaction-area {
  z-index: 10;
  flex: 1;
  background: #11151f;
  border-top: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  padding: 0.35rem;
  margin-top: auto;
}

.method-tabs {
  display: flex;
  justify-content: center;
  gap: 0.21rem;
  margin-bottom: 0.42rem;
}

.tab-item {
  padding: 0.11rem 0.28rem;
  border-radius: 0.11rem;
  background: #2a3546;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 0.11rem;
  font-size: 0.25rem;
  border: 1px solid transparent;
  color: #aaa;
}

.tab-item.active {
  background: var(--primary-dark);
  color: #fff;
  border-color: var(--primary);
}

.auth-panel {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding-top: 0.18rem;
}

/* === ä¿®æ”¹éƒ¨åˆ†ï¼šè§†é¢‘åŒºåŸŸæ ·å¼ === */
.panel-face {
  width: 100%;
  display: flex;
  justify-content: center;
}

.video-container {
  width: 5.8rem;
  /* è°ƒæ•´æ–¹å½¢å®½åº¦ */
  height: 5rem;
  /* è°ƒæ•´æ–¹å½¢é«˜åº¦ï¼Œå½¢æˆçŸ©å½¢æˆ–æ­£æ–¹å½¢ */
  background: #000;
  border: 2px solid var(--primary);
  border-radius: 0.14rem;
  position: relative;
  overflow: hidden;
  box-shadow: 0 0 0.3rem rgba(0, 242, 255, 0.15);
}

.camera-view {
  width: 100%;
  height: 100%;
  object-fit: cover;
  /* ä¿è¯è§†é¢‘å¡«æ»¡å®¹å™¨ */
}

/* æ‰«æçº¿åŠ¨ç”» */
.scan-line {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 2px;
  background: linear-gradient(to right, transparent, var(--primary), transparent);
  animation: scan 2s linear infinite;
  z-index: 2;
  box-shadow: 0 0 8px var(--primary);
}

@keyframes scan {
  0% {
    top: 0;
    opacity: 0;
  }

  10% {
    opacity: 1;
  }

  90% {
    opacity: 1;
  }

  100% {
    top: 100%;
    opacity: 0;
  }
}

.face-text-overlay {
  position: absolute;
  bottom: 0.2rem;
  left: 0;
  width: 100%;
  text-align: center;
  color: var(--primary);
  font-size: 0.23rem;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
  z-index: 3;
}

/* === ç»“æŸä¿®æ”¹éƒ¨åˆ† === */

.panel-finger {
  text-align: center;
  padding-top: 0.35rem;
}

.panel-numpad {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
  max-width: 4.6rem;
}

.input-screen {
  margin-bottom: 0.28rem;
  text-align: center;
}

.input-label {
  font-size: 0.23rem;
  color: #888;
  transition: color 0.3s;
}

.input-label.text-error {
  color: var(--error);
}

.dots {
  display: flex;
  gap: 0.14rem;
  justify-content: center;
  margin-top: 0.14rem;
}

.dot {
  width: 0.14rem;
  height: 0.14rem;
  border-radius: 50%;
  background: #333;
  transition: background-color 0.1s;
}

.dot.filled {
  background: var(--primary);
}

.dot.error {
  background: var(--error);
}

.numpad-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.18rem;
  width: 100%;
  transition: opacity 0.3s;
}

.numpad-grid.disabled {
  opacity: 0.5;
  pointer-events: none;
}

.numpad-grid button {
  background: #1f2636;
  border: 1px solid #2a3546;
  color: #fff;
  font-size: 0.32rem;
  height: 0.85rem;
  border-radius: 0.11rem;
  cursor: pointer;
}

.numpad-grid button:active {
  background: var(--primary-dark);
  border-color: var(--primary);
}

.numpad-grid .action-btn {
  font-size: 0.23rem;
  color: #888;
}

.shake-anim {
  animation: shake 0.4s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
}

@keyframes shake {

  10%,
  90% {
    transform: translate3d(-1px, 0, 0);
  }

  20%,
  80% {
    transform: translate3d(2px, 0, 0);
  }

  30%,
  50%,
  70% {
    transform: translate3d(-4px, 0, 0);
  }

  40%,
  60% {
    transform: translate3d(4px, 0, 0);
  }
}

.success-overlay {
  position: absolute;
  inset: 0;
  background: #0a0e17;
  z-index: 100;
  display: flex;
  align-items: center;
  justify-content: center;
}

.success-content {
  text-align: center;
}

.checkmark-circle {
  width: 1.06rem;
  height: 1.06rem;
  background: var(--success);
  color: #000;
  font-size: 0.57rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 0.28rem;
}

.success-content h2 {
  margin: 0 0 0.09rem 0;
  font-size: 0.35rem;
}

.success-content p {
  margin: 0;
  font-size: 0.23rem;
  color: #888;
}

.slide-up-enter-active,
.slide-up-leave-active {
  transition:
    transform 0.3s,
    opacity 0.3s;
}

.slide-up-enter-from,
.slide-up-leave-to {
  transform: translateY(0.35rem);
  opacity: 0;
}

/* ğŸ‘‡ æ–°å¢ï¼šå€’è®¡æ—¶æ ·å¼ */
.countdown-timer {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.23rem;
  color: #ffc107;
  /* è­¦å‘Šè‰² */
  background: rgba(255, 193, 7, 0.1);
  padding: 5px 12px;
  border-radius: 12px;
  border: 1px solid rgba(255, 193, 7, 0.2);

  /* ç»å¯¹å®šä½åˆ°æ ‡é¢˜å’Œå–æ¶ˆæŒ‰é’®ä¹‹é—´ (å¯é€‰ï¼Œæ ¹æ®å¸ƒå±€è°ƒæ•´) */
  /*
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  */
}


</style>
